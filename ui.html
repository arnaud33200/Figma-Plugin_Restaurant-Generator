<p>Select a component, frame, group, or layer.</p>
<!-- <p>Supported layer names: ‘restaurant’, ‘address’, ‘cuisine’, ‘image’</p> -->

<p><br><b>Use cuisine types</b></p>
<p><select id="merchant_selector" class="restaurant-drop-selector">
</select></p>

<button id="apply_button" class="main-button">Apply restaurant data</button>

<div style="margin-top: 20px;">
  <error id="error_message"></error>
</div>

<script>
  
  parent.postMessage({ pluginMessage: { type: 'get_merchants' } }, '*')
  
  document.getElementById('apply_button').onclick = () => {
    let selectElement = document.getElementById("merchant_selector");
    showErrorMessage("");
    parent.postMessage({ 
      pluginMessage: { 
        type: 'populate_merchant_node',
        merchantId: selectElement.selectedOptions[0].value
      } 
    }, '*')
  }
  
  onmessage = (event) => {
    let eventData = event.data.pluginMessage;
    if (eventData.type === 'merchants_response') { populateMerchantDropDown(eventData.merchants); }
    if (eventData.type === 'download_image') { downloadImage(eventData.nodeId, eventData.url); }
    if (eventData.type === 'error_message') { showErrorMessage(eventData.message); }
  }
  
  function populateMerchantDropDown(merchants) {
    let selectElement = document.getElementById("merchant_selector");
    merchants.forEach((merchant) => {
      let optionElement = document.createElement("option");
      optionElement.value = merchant.merchantId;
      optionElement.innerHTML = merchant.name;
      selectElement.appendChild(optionElement);
    })
    
  }

  function showErrorMessage(message) {
    document.getElementById('error_message').innerHTML = "<p>" + message + "</p>";
  }
  
  function downloadImage(nodeId, url) {
    // debugger;
    let request = new XMLHttpRequest();
    request.open('GET', url);
    request.responseType = 'arraybuffer';
    
    request.setRequestHeader('Content-Type', 'application/json');
    
    // placehold.it
    // unsplash
    
    request.onload = () => {
      let arraybuffer = request.response;
      let dataArray = new Uint8Array(arraybuffer)
      
      // debugger;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'on_image_data_response',
          nodeId: nodeId, 
          data: dataArray 
        } 
      }, '*');
    };
    request.send(null);
  }
  
</script> 

<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<style>

  :root {
    --button-text-color: #ffffff;
    --button-bg-color: #21292f;
  }

  p {
    font-family: sans-serif;
    margin-block-start: 2px;
    margin-block-end: 2px;
  }

  error {
    color: rgb(136, 0, 0);
    margin-top: 20px;
  }

  .main-button {
      width: -webkit-fill-available;
      padding: 10px;
      background-color: var(--button-bg-color);
      color: var(--button-text-color);
      border-radius: 5px;
      margin-top: 10px;
  }

  .restaurant-drop-selector {
    padding: 10px;
    width: -webkit-fill-available;
    border-radius: 5px;
    margin-top: 10px;
  }

</style>

