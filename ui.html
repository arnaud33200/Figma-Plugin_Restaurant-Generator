<h2>Select Merchant</h2>

<p><select id="merchant_selector">
</select></p>

<button id="apply_button">Apply Merchant</button>

<script>
  
  parent.postMessage({ pluginMessage: { type: 'get_merchants' } }, '*')
  
  document.getElementById('apply_button').onclick = () => {
    let selectElement = document.getElementById("merchant_selector");
    parent.postMessage({ 
      pluginMessage: { 
        type: 'populate_merchant_node',
        merchantId: selectElement.selectedOptions[0].value
      } 
    }, '*')
  }
  
  onmessage = (event) => {
    let eventData = event.data.pluginMessage;
    if (eventData.type === 'merchants_response') { populateMerchantDropDown(eventData.merchants); }
    if (eventData.type === 'download_image') { downloadImage(eventData.nodeId, eventData.url); }
  }
  
  function populateMerchantDropDown(merchants) {
    let selectElement = document.getElementById("merchant_selector");
    merchants.forEach((merchant) => {
      let optionElement = document.createElement("option");
      optionElement.value = merchant.merchantId;
      optionElement.innerHTML = merchant.name;
      selectElement.appendChild(optionElement);
    })
    
  }
  
  function downloadImage(nodeId, url) {
    // debugger;
    let request = new XMLHttpRequest();
    request.open('GET', url);
    request.responseType = 'arraybuffer';
    
    request.setRequestHeader('Content-Type', 'application/json');
    
    // placehold.it
    // unsplash
    
    request.onload = () => {
      let arraybuffer = request.response;
      let dataArray = new Uint8Array(arraybuffer)
      
      // debugger;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'on_image_data_response',
          nodeId: nodeId, 
          data: dataArray 
        } 
      }, '*');
    };
    request.send(null);
  }
  
</script> 
